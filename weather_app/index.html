<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Weather app with 5-day forecast based on your location">
    <title>Weather App</title>
    <link href="./css/base.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.12/css/weather-icons.min.css" rel="stylesheet">
</head>
<body>

<header class="app-header">
    <h1 class="sr-only">Weather</h1>
</header>

<section id="location-panel" aria-labelledby="manual-title">
    <h2 id="location-title" class="sr-only">Input location</h2>
    <form id="manual-form" class="manual-controls">
        <label>
            Latitude
            <input id="lat-input" type="number" step="any" min="-90" max="90" required>
        </label>
        <label>
            Longitude
            <input id="lon-input" type="number" step="any" min="-180" max="180" required>
        </label>
        <button id="btn-submit" type="submit">Get Weather</button>
        <button id="btn-auto" type="button">Auto</button>
    </form>
</section>
<p id="form-message" class="message" hidden></p>

<main>
    <section id="today" aria-labelledby="today-title">
        <h2 id="today-title">Today</h2>
        <div class="today-card" aria-label="Current conditions">
            <div class="today-temp">
                <output id="temp-now" aria-label="Current temperature">--</output>
                <div class="hi-low">
                    <span id="today-high" aria-label="High">--</span>
                    <span id="today-low" aria-label="Low">--</span>
                </div>
            </div>
            <figure class="today-icon">
                <img id="icon-today" src="" alt="" width="64" height="64">
                <figcaption id="weather-today"></figcaption>
            </figure>
            <p id="location" class="meta">Locating…</p>
        </div>
        <p id="weather-message" class="message" hidden></p>
    </section>

    <section id="forecast" aria-labelledby="forecast-title">
        <h2 id="forecast-title">5-Day Forecast</h2>
        <ul id="forecast-list" class="forecast-list">
            <!-- JS fills <li class="day-card"> items -->
        </ul>
    </section>

    <nav aria-label="Location controls">
        <button id="btn-history" type="button">History</button>
    </nav>

    <ul id="history-list" class="history-list" hidden>
        <!-- JS fills -->
    </ul>
</main>

<script type="module">
    import {getCurrentPosition} from "./js/geolocation.js";
    import {fetchWeather} from "./js/getweather.js";
    import {getAddress,fmtF,WMO} from "./js/util.js";
    let lat, lon;
    const $={
        latInput : document.getElementById("lat-input"),
        lonInput : document.getElementById("lon-input"),
        formMessage: document.getElementById("form-message"),
        location: document.getElementById("location"),
        weatherMessage: document.getElementById("weather-message"),
        todayHigh:document.getElementById("today-high"),
        todayLow:document.getElementById("today-low"),
        tempNow:document.getElementById("temp-now"),
        weatherToday:document.getElementById("weather-today"),
        forecastList:document.getElementById("forecast-list"),
    }
    async function getLocation(){
        try {
            const pos = await getCurrentPosition();
            lat = pos.latitude;
            lon = pos.longitude;
            $.latInput.value=lat.toFixed(6);
            $.lonInput.value=lon.toFixed(6);
            void getWeather();
        }
        catch (e) {
            $.formMessage.textContent="Auto Location Failed. Input Manually.";
            $.formMessage.hidden=false;
        }
    }

    async function getWeather(){
        // this api does not support fetching address, must do it manually first
        try{
            const addr=await getAddress(lat,lon);
            if(addr.country!=="United States"){
                $.formMessage.textContent="Warning: Weather outside US may be inaccurate.";
                $.formMessage.hidden=false;
            }
            $.location.textContent=`${addr.city??"Unknown"}, ${addr.state??"Unknown"}, ${addr.country??"Unknown"} `;
        }
        catch (e) {
            $.formMessage.textContent=e.message;
            $.formMessage.hidden=false;
        }
        // now we can fetch weather
        const data=await fetchWeather(lat,lon)
            .catch(e=>{
                $.weatherMessage.textContent="Failed to fetch weather. "+e.message;
                $.weatherMessage.hidden=false;
            })
        try{
            const tNow = data.current?.temperature_2m;
            const isDayNow = data.current?.is_day === 1;
            const hi0 = data.daily?.temperature_2m_max?.[0];
            const lo0 = data.daily?.temperature_2m_min?.[0];

            $.tempNow.textContent = fmtF(tNow);
            $.todayHigh.innerHTML = "H " + fmtF(hi0);
            $.todayLow.innerHTML = "L " + fmtF(lo0);

            const weather = WMO[data.current?.weather_code]
            $.weatherToday.textContent = weather.description;
            document.getElementById("icon-today").className = `wi ${isDayNow?weather.day||weather.night}`
            $.iconToday.alt = weather;
            $.iconToday.width = 64;
            $.iconToday.height = 64;
            $.iconToday.loading = "eager";
            const days = data.daily?.time || [];
            const highs = data.daily?.temperature_2m_max || [];
            const lows = data.daily?.temperature_2m_min || [];
            const codes = data.daily?.weather_code || [];

            $.forecastList.innerHTML = "";
            days.forEach((iso, i) => {
                const d = new Date(iso + "T00:00:00");
                const label = d.toLocaleDateString("en-US", {weekday: "short"});
                const hi = highs[i];
                const lo = lows[i];
                const txt = WMO[codes[i]] || "—";
                const codeDay = codes[i];
                const li = document.createElement("li");
                li.className = "day-card";
                li.tabIndex = 0;
                li.setAttribute("aria-label", `${label}: High ${Math.round(hi)}° F, Low ${Math.round(lo)}° F, ${txt}`);
                li.innerHTML =
                    `<time datetime="${iso}">${label}</time>` +
                    `<img src="${iconPath(codeDay, true)}" alt="${txt}" width="48" height="48" loading="lazy" />` +
                    `<div class="hi-low"><span>${fmtF(hi)}</span><span>${fmtF(lo)}</span></div>`;
                $.forecastList.appendChild(li);
            });
        }
        catch(e){
            $.weatherMessage.textContent="Failed to process data. "+e.message;
            $.weatherMessage.hidden=false;
        }
    }

    document.getElementById("manual-form").onsubmit = (e) => {
        e.preventDefault();
        lat = parseFloat($.latInput.value);
        lon = parseFloat($.lonInput.value);
        document.querySelectorAll(".message").forEach(el => el.hidden = true);
        void getWeather();
    };
    document.getElementById("btn-auto").onclick = () =>{
        document.querySelectorAll(".message").forEach(el => el.hidden = true);
        void getLocation();
    }
    void getLocation();
</script>
</body>
</html>